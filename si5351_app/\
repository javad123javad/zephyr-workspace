#include <zephyr/kernel.h>
#include <zephyr/drivers/i2c.h>
#include "si5351.h"

#define I2C_DEV DT_LABEL(DT_NODELABEL(i2c0))
#define SI5351_I2C_ADDR 0x60

int main(void) {
    const struct device *i2c_dev = DEVICE_DT_GET(DT_NODELABEL(i2c0));
    if (!i2c_dev) {
        printk("I2C device not found\n");
        return -EIO;
    }

    struct si5351_dev si_dev = {
        .i2c_dev = i2c_dev,
        .i2c_addr = SI5351_I2C_ADDR,
    };

    int ret = i2c_configure(i2c_dev, I2C_SPEED_SET(I2C_SPEED_STANDARD) | I2C_MODE_CONTROLLER);
    if (ret) {
        printk("I2C configure error: %d\n", ret);
        return;
    }

    // Initialize Si5351 with a correction factor (e.g., 970 Hz @ 100 MHz)
    ret = si5351_init(&si_dev, 970);
    if (ret) {
        printk("Si5351 init failed: %d\n", ret);
        return;
    }

    // Setup CLK0 to 10 MHz with 8mA drive strength
    ret = si5351_setup_clk0(&si_dev, 15000000, SI5351_DRIVE_STRENGTH_8MA);
    if (ret) {
        printk("CLK0 setup failed: %d\n", ret);
        return;
    }

    // Setup CLK2 to 25 MHz with 4mA drive strength
    ret = si5351_setup_clk2(&si_dev, 10000000, SI5351_DRIVE_STRENGTH_4MA);
    if (ret) {
        printk("CLK2 setup failed: %d\n", ret);
        return;
    }

    // Enable CLK0 and CLK2
    ret = si5351_enable_outputs(&si_dev, (1 << 0) | (1 << 2));
    if (ret) {
        printk("Enable outputs failed: %d\n", ret);
        return;
    }

    printk("Si5351 configured successfully\n");

    while (1) {
        k_sleep(K_MSEC(1000));
    }
}
